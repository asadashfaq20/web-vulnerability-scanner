#!/usr/bin/env python3

from scanner import Scanner
import argparse
from urllib.parse import urljoin

parser = argparse.ArgumentParser()
parser.add_argument("-t", "--target", dest="target_url", help="Target IP or URL")
parser.add_argument("-l", "--login", dest="login_url", help="Login URL in case you have register account in target system")
parser.add_argument("-u", "--username", dest="username", help="Enter Username or Email")
parser.add_argument("-p", "--password", dest="password", help="Enter Password")
parser.add_argument("-r", "--report", dest="report", help="Generate Report Y|N")
args = parser.parse_args()
#group of arguments

# target_url = "http://192.168.226.131/dvwa/"
target_url = args.target_url
if target_url is None:
    print("Target URL is Mandatory")
    exit(0)

report = args.report
if report is None and report not in ['Y', 'y']:
    report = "N"

links_to_ignore = ["http://192.168.226.131/dvwa/logout.php"]
#possible username fields mactches
username_names = ["username", "user", "email", "usr"]
#possible password fields matches
password_names = ["password", "pass", "upass", "passwrd"]

vuln_scanner = Scanner(target_url, links_to_ignore, report)

login_details = {}
login_url = args.login_url
username = args.username
password = args.password

if login_url is not None and username is not None and password is not None:
    login_form = vuln_scanner.extract_forms(login_url)[0]
    login_fields = login_form.findAll("input")
    # login_post_url = "http://192.168.226.131/dvwa/login.php"
    login_post_url = urljoin(target_url, login_form.get("action"))

    print(f"\n{'*'* (len(login_post_url)+18)}\n")
    print(f"LOGIN POST URL => {login_post_url}")
    print(f"\n{'*'* (len(login_post_url)+18)}\n")

    for inp in login_fields:
        if inp.get("name") in username_names:
            login_details[inp.get("name")] = username
            continue
        if inp.get("name") in password_names:
            login_details[inp.get("name")] = password
            continue
        login_details[inp.get("name")] = inp.get("value")

    # print(login_details)
    vuln_scanner.session.post(login_post_url, data=login_details)

vuln_scanner.crawl()
vuln_scanner.run_scanner()